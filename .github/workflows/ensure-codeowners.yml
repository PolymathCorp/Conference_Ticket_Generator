name: Ensure CODEOWNERS on Dispatch

on:
  repository_dispatch:
    types: [ensure-codeowners]

permissions:
  contents: write

jobs:
  ensure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for CODEOWNERS
        id: exists
        uses: andstor/file-existence-action@v2
        with:
          files: |
            CODEOWNERS
            .github/CODEOWNERS

      - name: Get repo name
        id: repo
        run: echo "repo=${GITHUB_REPOSITORY#*/}" >> "$GITHUB_OUTPUT"

      - name: Generate CODEOWNERS from collaborators
        if: steps.exists.outputs.files_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Generating CODEOWNERS for $GITHUB_REPOSITORY"
          echo "# Autogenerated CODEOWNERS" > CODEOWNERS

          # Get list of collaborators with write/admin access
          collaborators=$(gh api repos/${{ github.repository }}/collaborators \
            --jq '[.[] | select(.permissions.push == true or .permissions.admin == true) | "@"+.login]' | jq -r '. | join(" ")')

          echo "* $collaborators" >> CODEOWNERS
          echo "CODEOWNERS generated:"
          cat CODEOWNERS

      - name: Commit & push
        if: steps.exists.outputs.files_exists == 'false'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: CODEOWNERS
          commit_message: "chore: add CODEOWNERS from collaborators"
